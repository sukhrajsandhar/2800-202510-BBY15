<%- include('templates/header', { cssFiles: ['/styles.css', '/footer.css',
'/alerts.css', '/header.css', '/bg.css'] }) %>

<main>
    <div>
        <div class="container" style="margin-top: 80px; margin-bottom: 100px; max-width: 700px; overflow-y: auto;">
            <h4 class="mb-4">Reviews for <%= campsite.name %></h4>
    </div>
    <div class="container">
        <% if (booking && booking.length > 0) { %> <%
        booking.forEach(function(booking) { %>
        <div class="card">
            <div class="card-header">
                <h5>DATES:</h5>
                <p><%= booking.startDate %> - <%= booking.endDate %></p>
            </div>

            <div class="card-body">
                <div class="card-title d-flex">
                    <h5><%= booking.firstName %></h5>
                    <small style="position: absolute; right: 20px"
                        >Tent spots: <%= booking.tentSpots %></small
                    >
                </div>
                <p class="card-text"><%= booking.summary %></p>
                <button
                    id="book-btn"
                    type="button"
                    style="
                        background-color: rgb(40, 63, 59);
                        outline-color: #95bf74;
                    "
                    class="btn btn-primary"
                    data-booking-id="<%= booking._id %>"
                >
                    Contact Booking Owner
                </button>
            </div>
        </div>
        <% }) %> <% } else { %>
        <div class="d-flex justify-content-center align-items-center p-4"style="color: #888">
            No bookings available for this campsite yet.
            <img class="notAvail p-2" src="/notAvail.png"/>
        </div>
        <% } %>
    </div>
</main>
<!-- <script src="/js/viewBookings.js"></script> -->
<script>
    document.querySelectorAll("#book-btn").forEach((button) => {
        button.onclick = () => contactOwner(button.dataset.bookingId);
    });

    function contactOwner(bookingId) {
        fetch(`/booking/${bookingId}/contact-info`)
            .then((res) => res.json())
            .then((data) => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const { name, email, campsiteName, startDate, endDate, userFirstName } = data;
                const currentUser = "<%= currentUserFirstName %>"; // You must pass this from your EJS route

                // Create the email body using the template
                const subject = `Re: ${campsiteName} Campsite Availability`;
                const body = `Hi ${userFirstName},%0D%0A%0D%0A` +
                    `Thanks for offering to share your spot at ${campsiteName} — I’d love to join if there’s still room!%0D%0A%0D%0A` +
                    `Those dates (${startDate} to ${endDate}) work great for me. I can bring my own gear and chip in for anything else you need. %0D%0A%0D%0A` +
                    `Please let me know if you have any plans for the trip, if I can join, and what I should bring.%0D%0A%0D%0A` +
                    `Looking forward to it!%0D%0A${currentUser}`;

                window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${body}`);
            })
            .catch((err) => {
                console.error(err);
                alert("Failed to get contact info.");
            });
    }

</script>

<%- include('templates/footer') %>
