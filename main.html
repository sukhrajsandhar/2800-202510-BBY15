<!DOCTYPE html>
<html lang="en">

<head>
    <title>Wildpath</title>
    <meta name="comp2800 template" content="My 2800 App">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <!-- Your styles -->
    <link rel="stylesheet" href="./styles/main.css">
    <link rel="stylesheet" href="./styles/map.css">
</head>

<body>
    <!-- Map container -->
    <div id="map"></div>

    <!-- Floating search bar -->
        <div class="search-container">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="location-lookup" placeholder="Search for a location..." autocomplete="address-line1">
            </div>
            <div class="location-display">
                <i class="fas fa-location-dot"></i>
                <span id="current-location">Getting location...</span>
            </div>
            <div class="weather-display">
                <span id="weather-info">Loading weather...</span>
            </div>
        </div>

    <!-- Floating navigation -->
    <nav class="nav-container">
        <div class="nav-links">
            <a href="main.html" class="nav-link active">
                <i class="fas fa-compass"></i>
                <span>Map</span>
            </a>
            <a href="favorites.html" class="nav-link">
                <i class="fas fa-star"></i>
                <span>Favorites</span>
            </a>
            <a href="bookings.html" class="nav-link">
                <i class="fas fa-campground"></i>
                <span>Bookings</span>
            </a>
            <a href="profile.html" class="nav-link">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </div>
    </nav>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

        <script type="module">
        import config from './config.js';

        // Initialize map
        mapboxgl.accessToken = config.MAPBOX_ACCESS_TOKEN;
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/str4t/cm7s21ut7003s01snduvec3nn',
            center: [-123.1207, 49.1527],
            zoom: 9
        });

        // Add geolocation control
        const geolocateControl = new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        });

        map.addControl(geolocateControl);

        // Update location display when position changes
        geolocateControl.on('geolocate', async (e) => {
            const locationDisplay = document.getElementById('current-location');
            const weatherInfo = document.getElementById('weather-info');
            const lat = e.coords.latitude;
            const lng = e.coords.longitude;
            
            try {
                // Reverse geocode the coordinates to get the address
                const response = await fetch(
                    `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}`
                );
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    // Get the most relevant address
                    const address = data.features[0].place_name;
                    locationDisplay.textContent = address;
                } else {
                    locationDisplay.textContent = 'Address not found';
                }
            } catch (error) {
                console.error('Error getting address:', error);
                locationDisplay.textContent = 'Error getting address';
            }

            // Fetch weather from OpenWeatherMap
            try {
                const OPENWEATHER_API_KEY = 'f7cb5e5c969b57971a8aa3ff7dac3f59';
                const weatherRes = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${OPENWEATHER_API_KEY}`
                );
                const weatherData = await weatherRes.json();
                if (weatherData && weatherData.weather && weatherData.weather.length > 0) {
                    const temp = Math.round(weatherData.main.temp);
                    const desc = weatherData.weather[0].description;
                    const icon = weatherData.weather[0].icon;
                    weatherInfo.innerHTML = `<img src='https://openweathermap.org/img/wn/${icon}.png' alt='${desc}' style='vertical-align:middle;width:20px;height:20px;'> ${temp}Â°C, ${desc}`;
                } else {
                    weatherInfo.textContent = 'Weather not found';
                }
            } catch (error) {
                console.error('Error getting weather:', error);
                weatherInfo.textContent = 'Error getting weather';
            }
        });

        // Add navigation control
        map.addControl(new mapboxgl.NavigationControl({ showCompass: true }), 'top-right');

        // Add geocoder
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Search for a location...',
            marker: false,
            flyTo: {
                bearing: 0,
                essential: true,
                padding: {top: 0, bottom: 0, left: 0, right: 0},
                zoom: 14
            }
        });

        // Add geocoder to the search input
        const searchInput = document.getElementById('location-lookup');
        searchInput.parentNode.replaceChild(geocoder.onAdd(map), searchInput);

        // Handle geocoder results
        geocoder.on('result', (event) => {
            const result = event.result;
            // Fly to the selected location
            map.flyTo({
                center: result.center,
                zoom: 14,
                essential: true
            });
        });

        // Handle geocoder clear
        geocoder.on('clear', () => {
            // Reset the map view when search is cleared
            map.flyTo({
                center: [-123.1207, 49.1527],
                zoom: 9,
                essential: true
            });
        });

        // Add active state to current page in navigation
        const currentPage = window.location.pathname.split('/').pop();
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        // Add BC Parks camping locations
        map.on('load', () => {
            // Sample camping locations in BC with detailed information
            const campingLocations = [
                {
                    name: "Alice Lake Provincial Park",
                    coordinates: [-123.0775, 49.7775],
                    type: "Provincial Park",
                    facilities: ["Camping", "Hiking", "Swimming", "Fishing", "Mountain Biking"],
                    description: "A family-friendly park with four freshwater lakes, perfect for swimming and fishing.",
                    season: "Year-round",
                    reservation: "https://bcparks.ca/reserve/",
                    fees: {
                        camping: "$35/night",
                        dayUse: "$3/person"
                    },
                    amenities: ["Flush Toilets", "Showers", "Drinking Water", "Fire Pits", "Picnic Tables"],
                    difficulty: "Easy",
                    rating: 4.8,
                    reviews: 245
                },
                {
                    name: "Porteau Cove Provincial Park",
                    coordinates: [-123.2375, 49.5575],
                    type: "Provincial Park",
                    facilities: ["Camping", "Scuba Diving", "Swimming", "Fishing", "Boating"],
                    description: "Popular marine park with stunning views of Howe Sound and excellent diving opportunities.",
                    season: "Year-round",
                    reservation: "https://bcparks.ca/reserve/",
                    fees: {
                        camping: "$35/night",
                        dayUse: "$3/person"
                    },
                    amenities: ["Flush Toilets", "Drinking Water", "Fire Pits", "Picnic Tables", "Boat Launch"],
                    difficulty: "Easy",
                    rating: 4.7,
                    reviews: 189
                },
                {
                    name: "Buntzen Lake Recreation Area",
                    coordinates: [-122.8575, 49.3475],
                    type: "Regional Park",
                    facilities: ["Camping", "Hiking", "Swimming", "Fishing", "Mountain Biking"],
                    description: "Beautiful lake surrounded by mountains with extensive trail network and beach areas.",
                    season: "Year-round",
                    reservation: "https://www.metrovancouver.org/",
                    fees: {
                        camping: "$30/night",
                        dayUse: "$2/person"
                    },
                    amenities: ["Flush Toilets", "Drinking Water", "Fire Pits", "Picnic Tables", "Beach Access"],
                    difficulty: "Easy to Moderate",
                    rating: 4.6,
                    reviews: 312
                },
                {
                    name: "Rolley Lake Provincial Park",
                    coordinates: [-122.4275, 49.2775],
                    type: "Provincial Park",
                    facilities: ["Camping", "Hiking", "Swimming", "Fishing", "Canoeing"],
                    description: "Peaceful lake setting with old-growth forest and family-friendly activities.",
                    season: "Year-round",
                    reservation: "https://bcparks.ca/reserve/",
                    fees: {
                        camping: "$35/night",
                        dayUse: "$3/person"
                    },
                    amenities: ["Flush Toilets", "Drinking Water", "Fire Pits", "Picnic Tables", "Boat Launch"],
                    difficulty: "Easy",
                    rating: 4.5,
                    reviews: 178
                },
                {
                    name: "Golden Ears Provincial Park",
                    coordinates: [-122.4775, 49.2775],
                    type: "Provincial Park",
                    facilities: ["Camping", "Hiking", "Swimming", "Horseback Riding", "Mountain Biking"],
                    description: "One of BC's largest parks with diverse recreational opportunities.",
                    season: "Year-round",
                    reservation: "https://bcparks.ca/reserve/",
                    fees: {
                        camping: "$35/night",
                        dayUse: "$3/person"
                    },
                    amenities: ["Flush Toilets", "Showers", "Drinking Water", "Fire Pits", "Picnic Tables", "Horse Trails"],
                    difficulty: "Easy to Difficult",
                    rating: 4.7,
                    reviews: 312
                },
                {
                    name: "Cultus Lake Provincial Park",
                    coordinates: [-121.9975, 49.0475],
                    type: "Provincial Park",
                    facilities: ["Camping", "Swimming", "Boating", "Fishing", "Water Sports"],
                    description: "Popular lake destination with warm waters and sandy beaches.",
                    season: "Summer",
                    reservation: "https://bcparks.ca/reserve/",
                    fees: {
                        camping: "$35/night",
                        dayUse: "$3/person"
                    },
                    amenities: ["Flush Toilets", "Showers", "Drinking Water", "Fire Pits", "Picnic Tables", "Boat Launch"],
                    difficulty: "Easy",
                    rating: 4.6,
                    reviews: 423
                },
                {
                    name: "Sasquatch Provincial Park",
                    coordinates: [-121.9075, 49.2775],
                    type: "Provincial Park",
                    facilities: ["Camping", "Hiking", "Swimming", "Fishing", "Boating"],
                    description: "Scenic park with multiple lakes and beautiful mountain views.",
                    season: "Year-round",
                    reservation: "https://bcparks.ca/reserve/",
                    fees: {
                        camping: "$35/night",
                        dayUse: "$3/person"
                    },
                    amenities: ["Flush Toilets", "Drinking Water", "Fire Pits", "Picnic Tables", "Boat Launch"],
                    difficulty: "Easy to Moderate",
                    rating: 4.5,
                    reviews: 156
                },
                {
                    name: "Mount Seymour Provincial Park",
                    coordinates: [-122.9475, 49.3775],
                    type: "Provincial Park",
                    facilities: ["Camping", "Hiking", "Skiing", "Snowshoeing", "Wildlife Viewing"],
                    description: "Year-round recreation area with stunning views of Vancouver and surrounding mountains.",
                    season: "Year-round",
                    reservation: "https://bcparks.ca/reserve/",
                    fees: {
                        camping: "$35/night",
                        dayUse: "$3/person"
                    },
                    amenities: ["Pit Toilets", "Drinking Water", "Fire Pits", "Picnic Tables", "Ski Trails"],
                    difficulty: "Moderate to Difficult",
                    rating: 4.8,
                    reviews: 289
                },
                {
                    name: "Lynn Headwaters Regional Park",
                    coordinates: [-123.0275, 49.3775],
                    type: "Regional Park",
                    facilities: ["Camping", "Hiking", "Fishing", "Wildlife Viewing", "Photography"],
                    description: "Wilderness area with old-growth forest and extensive trail network.",
                    season: "Year-round",
                    reservation: "https://www.metrovancouver.org/",
                    fees: {
                        camping: "$30/night",
                        dayUse: "$2/person"
                    },
                    amenities: ["Pit Toilets", "Drinking Water", "Fire Pits", "Picnic Tables"],
                    difficulty: "Moderate to Difficult",
                    rating: 4.7,
                    reviews: 234
                },
                {
                    name: "Belcarra Regional Park",
                    coordinates: [-122.9275, 49.3175],
                    type: "Regional Park",
                    facilities: ["Camping", "Swimming", "Boating", "Fishing", "Hiking"],
                    description: "Coastal park with beautiful views of Indian Arm and Burrard Inlet.",
                    season: "Year-round",
                    reservation: "https://www.metrovancouver.org/",
                    fees: {
                        camping: "$30/night",
                        dayUse: "$2/person"
                    },
                    amenities: ["Flush Toilets", "Drinking Water", "Fire Pits", "Picnic Tables", "Boat Launch"],
                    difficulty: "Easy",
                    rating: 4.6,
                    reviews: 198
                }
            ];

            // Add markers for each camping location
            campingLocations.forEach(location => {
                // Create a custom marker element with enhanced styling
                const el = document.createElement('div');
                el.className = 'camping-marker';
                el.innerHTML = `
                    <div class="marker-container">
                        <div class="marker-icon">
                            <i class="fas fa-campground"></i>
                        </div>
                        <div class="marker-pulse"></div>
                    </div>
                `;
                el.style.cursor = 'pointer';

                // Create popup content with more details
                const popupContent = `
                    <div class="camping-popup">
                        <h4>${location.name}</h4>
                        <div class="popup-rating">
                            <span class="stars">${'â'.repeat(Math.floor(location.rating))}${'â'.repeat(5-Math.floor(location.rating))}</span>
                            <span class="rating">${location.rating} (${location.reviews} reviews)</span>
                        </div>
                        <p class="description">${location.description}</p>
                        <div class="popup-details">
                            <p><strong>Type:</strong> ${location.type}</p>
                            <p><strong>Season:</strong> ${location.season}</p>
                            <p><strong>Difficulty:</strong> ${location.difficulty}</p>
                            <p><strong>Fees:</strong> ${location.fees.camping}</p>
                        </div>
                        <div class="popup-amenities">
                            <h5>Amenities:</h5>
                            <ul>
                                ${location.amenities.map(amenity => `<li>${amenity}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="popup-actions">
                            <a href="${location.reservation}" target="_blank" class="reserve-btn">Make Reservation</a>
                        </div>
                    </div>
                `;

                // Create and add the marker
                new mapboxgl.Marker(el)
                    .setLngLat(location.coordinates)
                    .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupContent))
                    .addTo(map);
            });
        });
        </script>
</body>

</html>